<?php
class TxtToJson {
	private $suspDir = 'txts/suspicion';

	function __construct(){
		$suspFiles = $this->filesInDir($this->suspDir);
		foreach($suspFiles as $file){
			$this->convert(file_get_contents($this->suspDir.'/'.$file));
		}
	}
	private function filesInDir ($tdir) {
		if($dh = opendir ($tdir)) {
			$files = Array();
			while($a_file = readdir ($dh)) {
				if($a_file != '.' && $a_file != '..') array_push ($files , $a_file);
			}
			closedir ($dh);
			return $files;
		}
	}
	private function convert($txt){
		$txt = preg_replace('/“/', '"', $txt);
		$txt = preg_replace('/”/', '"', $txt);
		$txt = preg_replace('/\r/', '', $txt);
		$txt = preg_replace('/\s*(\s)/', '$1', $txt);
		$txt = preg_replace('/(<a.*)\n(.*<\/a>)/', '$1$2', $txt);

		preg_match_all('/.+\n/', $txt, $lines);
		$lines = $lines[0];
		$array = array(
			'title' => '',
			'background' => array('media'=>array(), 'content'=>array()),
			'witnesses'=> array(),
			'abstract' => array('media'=>array(), 'content'=>array()),
			'dialogue' => array(),
			'conclusion' => array('media'=>array(), 'content'=>array()),
			'etc' =>array('media'=>array(), 'content'=>array())
		);
		$curIndex = -1;
		$curLevel;
		$dialIdx_i = -1;
		$dialIdx_j = -1;
		$dialogueStart = false;
		foreach($lines as $line){
			$line = trim($line);
			if(preg_match('/(#+)\s/', $line, $match)){ // #이 있는 줄의 경우
				$curIndex++;
				if($afterDialogue) $idxAfter++;
				$curLevel = strlen($match[1]) - 1;
				if($curLevel == 0 && $curIndex == 0){ // 타이틀
					$array['title'] = preg_replace('/#.+[0-9]+\.\s+/', '', $line);
				} else if($curLevel == 1 && $curIndex == 4){
					$dialogueStart = true;
				} else if($curLevel == 1 && $curIndex > 4){
					$dialogueStart = false;
					//$idxAfter = true;
				} else if($curLevel == 2 && $dialogueStart){
					$dialIdx_i++; $dialIdx_j = -1;
					$array['dialogue'][$dialIdx_i] = array(
						'q_name'=>'', 'q_content'=>array(), 'q_media'=>array(),
						'a_name'=>'', 'a_content'=>array(), 'a_media'=>array()
					);
				} else if($curLevel == 2 && $curIndex > 1) { //함께 보기
					if(preg_match('/\[(.+)\|(.+)\|(.+)\]/', $line, $match)){
						$medium = array('url'=>$match[1], 'size'=>$match[2], 'caption'=>$match[3]);
						array_push($array['etc']['media'], $medium);
					} else {
						$line = preg_replace('/#+\s+/', '', $line);
						array_push($array['etc']['content'], $line);
					}
				} else if($curLevel == 3 && $dialogueStart){
					$line = preg_replace('/#+\s+/', '', $line);
					$dialIdx_j++;
					if($dialIdx_j == 0){
						$array['dialogue'][$dialIdx_i]['q_name'] = $line;
					} else if($dialIdx_j == 1){
						$array['dialogue'][$dialIdx_i]['a_name'] = $line;
					}
				} else if($curLevel == 4 & $dialogueStart){
					$line = preg_replace('/#+\s+/', '', $line);
					if($dialIdx_j == 0){
						array_push($array['dialogue'][$dialIdx_i]['q_content'], $line);
					} else if($dialIdx_j == 1){
						array_push($array['dialogue'][$dialIdx_i]['a_content'], $line);
					}
				}
			} else { // #이 없는 줄의 경우
				if($curLevel == 1 && $curIndex == 1){ // 의혹 배경
					if(preg_match('/\[(.+)\|(.+)\|(.+)\]/', $line, $match)){
						$medium = array('url'=>$match[1], 'size'=>$match[2], 'caption'=>$match[3]);
						array_push($array['background']['media'], $medium);
					} else {
						array_push($array['background']['content'], $line);
					}
				} else if($curLevel == 1 && $curIndex == 2){ //관련 증인
					$witnesses = explode(',', $line);
					foreach($witnesses as $witness) array_push($array['witnesses'], trim($witness));
				} else if($curLevel == 1 && $curIndex == 3){ //청문회 주요내용
					if(preg_match('/\[(.+)\|(.+)\|(.+)\]/', $line, $match)){
						$medium = array('url'=>$match[1], 'size'=>$match[2], 'caption'=>$match[3]);
						array_push($array['abstract']['media'], $medium);
					} else {
						array_push($array['abstract']['content'], $line);
					}
				} else if($curLevel == 1 && $curIndex > 4) { // 청문회를 마치고
					if(preg_match('/\[(.+)\|(.+)\|(.+)\]/', $line, $match)){
						$medium = array('url'=>$match[1], 'size'=>$match[2], 'caption'=>$match[3]);
						array_push($array['conclusion']['media'], $medium);
					} else {
						array_push($array['conclusion']['content'], $line);
					}
				} else if($curLevel == 4 && $dialogueStart){
					$key;
					$value;
					if(preg_match('/\[(.+)\|(.+)\|(.+)\]/', $line, $match)){
						$medium = array('url'=>$match[1], 'size'=>$match[2], 'caption'=>$match[3]);
						if($dialIdx_j == 0) $key = 'q_media';
						else if($dialIdx_j == 1) $key = 'a_media';
						$value = $medium;
					} else {
						if($dialIdx_j == 0) $key = 'q_content';
						else if($dialIdx_j == 1) $key = 'a_content';
						$value = $line;
					}
					array_push($array['dialogue'][$dialIdx_i][$key], $value);
				}
			}
		}// foreach
		echo '<xmp>';
		print_r($array);
		echo '</xmp>';
	}// convert()
}
new TxtToJson();
?>
